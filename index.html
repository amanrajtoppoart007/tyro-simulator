<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
<title>Tyro iClient Samples</title>
<style>
    body {
        padding-top: 60px;
        padding-bottom: 40px;
    }

    .mt15 {
        margin-top: 15px;
    }
</style>
<script type="text/javascript" src="//code.jquery.com/jquery-1.9.1.js"></script>
<script type="text/javascript" src="https://iclientsimulator.test.tyro.com/iclient-with-ui-v1.js"></script>
<script type="text/javascript">
    // Only required because we are loading both iclient versions into the global namespace
    var TYROUI_SIMULATOR = TYRO;
</script>
<script type="text/javascript" src="https://iclientsimulator.test.tyro.com/iclient-v1.js"></script>
<script type="text/javascript">
    // Only required because we are loading both iclient versions into the global namespace
    var CUSTOMUI_SIMULATOR = TYRO;
</script>
<script type="text/javascript" src="https://iclient.test.tyro.com/iclient-with-ui-v1.js"></script>
<script type="text/javascript">
    // Only required because we are loading both iclient versions into the global namespace
    var TYROUI_TEST = TYRO;
</script>
<script type="text/javascript" src="https://iclient.test.tyro.com/iclient-v1.js"></script>
<script type="text/javascript">
    // Only required because we are loading both iclient versions into the global namespace
    var CUSTOMUI_TEST = TYRO;
</script>
<script type="text/javascript">
    window.mid=0;
    window.tid=0;
    window.amount = 0;
    window.apiKey= '';
    window.posProductInfo =  {posProductVendor: "Tyro Payments", posProductName: "Mini Cloud POS", posProductVersion: "1.0.0"};
var system = [TYROUI_SIMULATOR, CUSTOMUI_SIMULATOR];
var configurationURLs = ["https://iclientsimulator.test.tyro.com/configuration.html", "https://iclient.test.tyro.com/configuration.html"];
var configurationUrl = configurationURLs[0];
var apiKey = "Test API Key";  // API Key not validated in either test environment
var posProductInfo = {posProductVendor: "Tyro Payments", posProductName: "Mini Cloud POS", posProductVersion: "1.0.0"};
var simulator = true;
var iclient;
var terminalStatus=0;
function doCancelTransaction() {
    if (iclient) {
        iclient.cancelCurrentTransaction();
    }
}





function switchToTestSystem() {
    system = [TYROUI_TEST, CUSTOMUI_TEST];
    configurationUrl = configurationURLs[1];
    simulator = false;
}

const sendResponse = (params)=>{
    if(window.ReactNativeWebView!==null && window.ReactNativeWebView!==undefined)
   {
        params = JSON.stringify(params);
        window.ReactNativeWebView.postMessage(params);
   }
}

document.addEventListener('message', function(message) {
    const res = JSON.parse(message.data);
    if(res.action==='set-config')
    {
        window.apiKey = res.data.apiKey;
        window.posProductInfo = res.data.posProductInfo;
        const params = {
             action:'config-set',
             data: {},
            message:'config successfully set'
         }
         sendResponse(params);
    }

    if(res.action==='init-terminal')
    {
         try
         {
         iclient = new system[0].IClientWithUI(window.apiKey, window.posProductInfo);
         const mid = res.data.mid;
         const tid = res.data.tid;
         iclient.pairTerminal(mid, tid, function(response) {
        if ("success" === response.status) {
         const params = {
             action:'terminal-status-success',
             data: {
                 status: response.status,
                 message:response.message,
             },
         }
         sendResponse(params);
         terminalStatus = 1;
        } else if ("failure" === response.status) {
             const params = {
             action:'terminal-status-error',
             data: {
                 status: response.status,
                 message:response.message,
             },

         }
         sendResponse(params);
         terminalStatus = 0;
        } else {
             const params = {
             action:'terminal-status-unknown',
             data: {
                 status: response.status,
                 message:response.message,
             },
         }
         sendResponse(params);
         terminalStatus = 0;
        }
    });
         }
         catch (e) {

            const params = {
             action:'pairing-failed',
             data: {},
             message: e,
         }
         sendResponse(params);
         terminalStatus=0;
         }
    }

    if(res.action==='init-purchase')
    {
         try {
            if(terminalStatus===1 && iclient!==null && iclient!==undefined)
         {
               iclient.initiatePurchase({amount: res.data.amount, cashout:res.data.cashout, integratedReceipt: true}, {
        receiptCallback: function (receipt) {

            const params = {
                action:'merchant-receipt-success',
                data: receipt.merchantReceipt,
            }
            sendResponse(params);
        },
        transactionCompleteCallback: function (response) {
            if (response.customerReceipt) {
                const params = {
                action:'customer-receipt-success',
                data: receipt.customerReceipt,
            }
            sendResponse(params);
            }

            const params = {
                action:'transaction-success',
                data: response,
            }
            sendResponse(params);
        }
    });
         }
         else
         {
            const params = {
                action:'terminal-error',
                data: 'terminal not ready',
            }
            sendResponse(params);
         }
         } catch (error) {
            const params = {
                action:'error',
                data: {
                    apiKey: window.apiKey,
                }
            }
            sendResponse(params);
         }
    }
});
</script>
</head>
<body></body>
</html>
