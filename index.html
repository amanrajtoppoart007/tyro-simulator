<!doctype html>
<!--suppress ES6ConvertVarToLetConst -->
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
<title>Tyro iClient Samples</title>
<script type="text/javascript" src="https://code.jquery.com/jquery-1.9.1.js"></script>
<script type="text/javascript" src="https://iclientsimulator.test.tyro.com/iclient-with-ui-v1.js"></script>
<script type="text/javascript">
    // Only required because we are loading both iClient versions into the global namespace
    var TYROUI_SIMULATOR = TYRO;
</script>
<script type="text/javascript" src="https://iclientsimulator.test.tyro.com/iclient-v1.js"></script>
<script type="text/javascript">
    // Only required because we are loading both iClient versions into the global namespace
    var CUSTOMUI_SIMULATOR = TYRO;
</script>
<script type="text/javascript" src="https://iclient.test.tyro.com/iclient-with-ui-v1.js"></script>
<script type="text/javascript">
    // Only required because we are loading both iClient versions into the global namespace
   // var TYROUI_TEST = TYRO;
</script>
<script type="text/javascript" src="https://iclient.test.tyro.com/iclient-v1.js"></script>
<script type="text/javascript">
    // Only required because we are loading both iClient versions into the global namespace
   // var CUSTOMUI_TEST = TYRO;
</script>
<script type="text/javascript">
var mid=329;
var tid=100;
var amount = 0;
var cashout =0;
var apiKey= 'f0ab83eca79eb90ef134';
var posProductInfo =  {posProductVendor: "Tyro Payments", posProductName: "Mini Cloud POS", posProductVersion: "1.0.0"};
var system = [TYROUI_SIMULATOR, CUSTOMUI_SIMULATOR];
var configurationURLs = ["https://iclientsimulator.test.tyro.com/configuration.html", "https://iclient.test.tyro.com/configuration.html"];
var configurationUrl = configurationURLs[0];
var simulator = true;
var terminalStatus=0;
function switchToSimulator() {
    system = [TYROUI_SIMULATOR, CUSTOMUI_SIMULATOR];
    configurationUrl = configurationURLs[0];
    simulator = true;
}

const sendResponse = (params)=>{
    params = JSON.stringify(params);
    if(window.ReactNativeWebView!==null && window.ReactNativeWebView!==undefined)
   {

        window.ReactNativeWebView.postMessage(params);
   }
   else
   {
        console.log(params);
   }
}

function doPurchaseWithTyroUI(_amount,_cashout,isReceipt,isSurcharge)
{
    try
    {
      if(terminalStatus===1)
         {
              let iClient = new system[0].IClientWithUI(apiKey, posProductInfo);
               amount = String(_amount.toFixed(0)).toString();
               cashout = String(_cashout.toFixed(0)).toString();
     iClient.initiatePurchase({amount: amount, cashout:_cashout, integratedReceipt: isReceipt, enableSurcharge: isSurcharge}, {
        receiptCallback: function (receipt) {
            const params = {
                action:'merchant-receipt-success',
                data: receipt.merchantReceipt,
            }
            sendResponse(params);
        },
        transactionCompleteCallback: function (response) {
            if (response.customerReceipt) {
                const params = {
                action:'customer-receipt-success',
                data: response.customerReceipt,
            }
            sendResponse(params);
            }
            const params = {
                action:'transaction-complete',
                data: response,
            }
            sendResponse(params);
        }
    });
         }
         else
         {
            const params = {
                action:'terminal-error',
                data: {
                    mid:mid,
                    tid:tid,
                },
                message:'terminal not ready'
            }
            sendResponse(params);
         }
    } catch(e) {
       const params = {
                action:'terminal-error',
                data: {
                    mid:mid,
                    tid:tid,
                },
                message:e
            }
            sendResponse(params);
    }
}

function doRefundWithTyroUI(_amount) {
  try
  {
      let iClient = new system[0].IClientWithUI(apiKey, posProductInfo);
      amount = String(_amount.toFixed(0)).toString();
    iClient.initiateRefund({amount: amount, integratedReceipt: true}, {
        receiptCallback: function (receipt) {
           const params = {
                action:'merchant-receipt-success',
                data: receipt.merchantReceipt,
            }
            sendResponse(params);
        },
        transactionCompleteCallback: function (response) {
             if (response.customerReceipt) {
                const params = {
                action:'customer-receipt-success',
                data: response.customerReceipt,
            }
            sendResponse(params);
            }
            const params = {
                action:'refund-complete',
                data: response,
            }
            sendResponse(params);
        }
    });
  }
  catch(e) {
       const params = {
                action:'terminal-error',
                data: {
                    mid:mid,
                    tid:tid,
                },
                message:e
            }
            sendResponse(params);
    }
}

document.addEventListener('message', function(message) {
    const res = JSON.parse(message.data);
    if(res.action==='set-config')
    {
        switchToSimulator();
        apiKey = res.data.apiKey;
        posProductInfo = res.data.posProductInfo;
        mid= res.data.mid;
        tid=res.data.tid;
        const params = {
             action:'config-set',
             data: {
                apiKey: apiKey,
                posProductInfo:posProductInfo,
             },
            message:'config successfully set'
         }
          terminalStatus = 1;
         sendResponse(params);
    }
    if(res.action==='init-purchase')
    {
         const {amount:t_amount, cashout:t_cashout, isReceipt,isSurcharge} =res.data;
        doPurchaseWithTyroUI(t_amount,t_cashout,isReceipt??true,isSurcharge??false);
    }

    if(res.action==='init-refund')
    {
        doRefundWithTyroUI(res.data.amount);
    }

});
</script>
</head>
<body>

</body>
</html>
